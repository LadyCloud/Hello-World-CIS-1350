"use strict";YUI.add("xframe",function(a){function b(a){this._init(a)}window.JSON||(window.JSON=a.JSON),Function.prototype.bind||(Function.prototype.bind=function(a){var b=this;return function(){return b.apply(a,arguments)}}),b.prototype={_init:function(b){if(this.isProxy=b.isProxy,this.logoutURL=null,this.timeoutDelay=5e3,this._boundReceive=this._receive.bind(this),window.addEventListener?window.addEventListener("message",this._boundReceive,!1):window.attachEvent("onmessage",this._boundReceive),this._listeners=[],this._parseTimers=[],this._key=this._genKey(),this.isProxy){a.namespace("Messenger").logPerf=function(a,b){var c,d;window.console&&window.__mimStartTime&&(c=a,d=(new Date).getTime(),b&&(b+="-proxy",c+=" ~ "+b),window.console)};var c=window.location.href.split("#")[1].split("*");if(this._remoteKey=c[0],this._remoteDomain=c[2],this._pendingRequests={},!this._domainCheck(this._remoteDomain))throw new Error("Invalid source domain, xframe connection disallowed - "+c[2]);window.__mimStartTime=c[1],a.Messenger.logPerf("Proxy xframe loaded, generating and sending the key","xframe"),this._remoteWindow=window.parent,this._send(JSON.stringify({token:this._key,key:this._remoteKey}))}else{if(this._localId="msg_"+(new Date).getTime(),this._connected=!1,this._cbid=0,this._cbs=[],this._sendQueue=[],!b.proxy||!b.yuiPath||!b.xframePath)throw new Error("XFrame connect called without required parameters:  proxy, yuiPath, xframePath");this._url=b.proxy+"#"+this._key+"*"+(window.__mimStartTime?window.__mimStartTime:"")+"*"+b.localDomain+"*"+this._localId+"*y="+b.yuiPath+"*xframePath="+b.xframePath,a.log("Attempting to connect to server using URL "+this._url,"info","xframe"),this._createProxy(),this._remoteDomain=b.proxy}},destroy:function(){for(;this._listeners.length;)this._listeners.pop().detach();for(this.iframe&&(this.iframe.parentNode.removeChild(this.iframe),delete this.iframe);this._parseTimers.length;)clearTimeout(this._parseTimers.pop());this._removeWindowEvents(),this._connected=!1,this._destroyed=!0},_removeWindowEvents:function(){window.removeEventListener?window.removeEventListener("message",this._boundReceive,!1):window.detachEvent("onmessage",this._boundReceive)},_genKey:function(){return"main_"+Math.floor(1e18*Math.random()).toString(36)},_createProxy:function(){var b,c,d,e,f=this,g=f._url;if(this._proxyRetries=this._proxyRetries||0,1===this._proxyRetries)this._removeUrlParameters(g);else if(this._proxyRetries>4)return a.log("Error - giving up trying to create iframe.","xframe"),void this._initFailure();a.Messenger.logPerf("Injecting an invisible iframe proxy","xframe"),b=document.createElement("div"),e='<iframe style="visibility:hidden;position:absolute;border:none;height:0px;width:0px;left:-9999px;"></iframe>',b.innerHTML=e,c=b.firstChild,c.addEventListener?(c.addEventListener("load",f._iframeLoadComplete.bind(f),!1),c.addEventListener("error",f._iframeLoadError.bind(f),!1)):(c.attachEvent("onload",f._iframeLoadComplete.bind(f)),c.attachEvent("onerror",f._iframeLoadError.bind(f))),c.src=g,f._appendIframeToBody(c),this.iframe_onloadfired_timeout||(d=3e3+1e3*this._proxyRetries,this.iframe_onloadfired_timeout=setTimeout(function(){this._destroyed||this._iframe_loaded||(a.log("iFrame onload did not fire, retrying the iframe injection.","warn","xframe"),this.iframe_onloadfired_timeout=null,this._retryCreateProxy())}.bind(this),d)),this.iframe=c},_iframeLoadComplete:function(){var b=this;a.Messenger.logPerf("iFrame onload event fired","xframe"),this.iframe_onloadfired_timeout&&(clearTimeout(this.iframe_onloadfired_timeout),this.iframe_onloadfired_timeout=null,this._iframe_loaded=!0),this._remoteWindow=this.iframe.contentWindow,this._connected||this._destroyed||(this.iframe_load_timeout=setTimeout(function(){a.log("Did not finish the server handshake in time - retrying.","warn","xframe"),b._retryCreateProxy()},this.timeoutDelay))},_iframeLoadError:function(){a.log("In onerror function for "+this._url,"warn","xframe"),this._connected||this._destroyed||this._iframe_loaded||this._retryCreateProxy()},_appendIframeToBody:function(a){document.body.appendChild(a)},_removeUrlParameters:function(a){var b,c;b=a.indexOf("?"),c=a.indexOf("#"),b>-1&&c>b&&(a=a.split(a.substring(b,c)).join(""),this._src=a)},_retryCreateProxy:function(){this._destroyed||this._connected||(a.log("In load timeout for "+this._url,"info","xframe"),this.iframe&&(this.iframe.parentNode.removeChild(this.iframe),delete this.iframe),this._proxyRetries++,a.log("Creating another iframe - counter = "+this._proxyRetries,"info","xframe"),this._createProxy())},send:function(b){var c,d=b.method,e=b.url,f=b.body,g=b.callback,h=b.timeout,i=++this._cbid;return this._fatalError?void this._xframeInitializationError(g):(c=JSON.stringify({cbid:i,method:d,url:e,body:f,key:this._remoteKey,timeout:h}),this._cbs[i]=g,this._connected?this._send(c):(a.Messenger.logPerf("Proxy not available, adding to queue","xframe"),void this._sendQueue.push({data:b,callback:g})))},_send:function(b){var c=this;if(!this._remoteWindow)return void setTimeout(function(){c._send(b)},0);try{a.Messenger.logPerf("Sending postMessage to remote window","xframe"),b=b.replace(/\|/g,"__PIPE__"),this._remoteWindow.postMessage(b,this._remoteDomain)}catch(d){return a.log("Error attempting postMessage to "+this._remoteDomain,"xframe"),void(this._pmRetry?this._initFailure():(this._pmRetry=!0,setTimeout(function(){c._send(b)},100)))}this._pmRetry=!1},ajax:function(b,c,d,e,f){if(b&&c){var g,h=a.guid("xframereq_"),i=!1,j=this;g=this._createXHR(),g.open(b,c,!0),g.setRequestHeader("Content-Type","application/json;charset=utf-8"),g.setRequestHeader("X-Yahoo-Msgr-User-Agent","YahooMessenger/1.0 (Mail Messenger;1.0.0.0)"),this._pendingRequests[h]={},this._pendingRequests[h].request=g,g.onreadystatechange=function(){try{i=j._ajaxResponseProcessCallback(g,e)}catch(d){a.log("exception in XHR handler ["+b+" "+c+"]:"+d.message,"error","XFrame");try{j._xframeInternalError(e)}catch(f){a.log("exception in XHR handler callback:"+f.message,"error","XFrame")}}j._ajaxCleanStep(i,g,h)},this._pendingRequests[h].timer=setTimeout(function(){j._ajaxTimeoutRequestProcess(g,h,e)},f||18e5),g.send(d||"")}},_ajaxResponseProcessCallback:function(b,c){var d,e,f=!1;if(4===b.readyState&&!f){a.Messenger.logPerf("AJAX response received","xframe"),f=!0,d="{}",e="status unavailable";try{e=b.statusText}catch(g){}d=b.status>=200&&b.status<210?b.responseText:0===b.status||b.status>1e3?JSON.stringify({error:{code:800,detail:"Network error"},httpStatus:b.status,responseText:b.responseText||""}):JSON.stringify({error:{},httpStatus:b.status,detail:e,responseText:b.responseText||""}),c(d)}return f},_ajaxTimeoutRequestProcess:function(b,c,d){if(a.log("***** XFrame.js: client side timeout triggered."),b){b.onreadystatechange=null;try{b.abort()}catch(e){}b.abort=null,b=null}this._pendingRequests[c]&&delete this._pendingRequests[c],d({error:{code:700,detail:"Client Side Timeout"}})},_ajaxCleanStep:function(a,b,c){a&&(clearTimeout(this._pendingRequests[c].timer),delete this._pendingRequests[c],b.onreadystatechange=null,b.abort=null,b=null)},_receive:function(b){var c,d,e,f,g;if(b._event&&!b.data&&(b.data=b._event.data,b.source=b._event.source),a.Messenger.logPerf("postMessage Data received","xframe"),f={},g=b.origin,"string"==typeof b.data&&(f=a.Lang.trimLeft(b.data),f.length&&("{"===f.charAt(0)||"["===f.charAt(0)))){f=f.replace(/__PIPE__/g,"|");try{f=JSON.parse(f)}catch(h){f={}}if(!this._destroyed&&f&&f.key===this._key)if(this.isProxy)this._receiveProxy(f);else if(f.token){if(a.Messenger.logPerf("Initial xframe token handshake completed"),this.iframe_load_timeout&&(a.log("Clearing the timeout for "+this._url),clearTimeout(this.iframe_load_timeout),this.iframe_load_timeout=null),this._remoteKey=f.token,!this._domainCheck(g))throw new Error("Invalid domain error - "+g);for(a.log("proxy iframe loaded","info","xframe"),this._connected=!0;this._sendQueue.length;)c=this._sendQueue.shift(),this.send(c.data)}else{if(!this._connected)throw new Error("Received a response in xframe before the handshake completed - "+f);d=this._cbs[f.cbid],e=f.text,delete this._cbs[f.cbid];try{d(e)}catch(i){a.log("Unsetting logout URL failed.")}}}},_receiveProxy:function(b){var c=this;a.Lang.isUndefined(b.logoutURL)?b.command&&"cancelRequests"===b.command?this._cancelRequests():this.ajax(b.method,b.url,b.body,function(a){var d=JSON.stringify({cbid:b.cbid,text:a,key:c._remoteKey});c._parseTimers.push(setTimeout(function(){c._destroyed||c._send(d)},0))},b.timeout):this.setLogoutURL(b.logoutURL)},_domainCheck:function(a){for(var b,c=this._parseURI(a),d=c.host,e=[".yahoo.com"];e.length;)if(b=e.shift(),d.substr(d.length-b.length)===b)return this.otherDomain=c.protocol+"://"+c.host,!0;return!1},_parseURI:function(a){for(var b=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,c=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],d=/(?:^|&)([^&=]*)=?([^&]*)/g,e=b.exec(a),f={queryKey:{}},g=c.length;g--;)f[c[g]]=e[g]||"";return f.query.replace(d,function(a,b,c){b&&(f.queryKey[b]=c)}),f},cancelRequests:function(){if(!this._destroyed&&this._connected){var a=JSON.stringify({command:"cancelRequests",key:this._remoteKey});this._remoteWindow.postMessage(a,this._remoteDomain)}},_cancelRequests:function(){var a,b;for(a in this._pendingRequests)if(this._pendingRequests.hasOwnProperty(a)){b=this._pendingRequests[a];try{b.request.abort()}catch(c){}b.timer&&clearTimeout(b.timer)}this._pendingRequests={}},sendLogoutURL:function(a){var b,c=this;if(!c._destroyed){if(!c._connected)return void setTimeout(function(){c.sendLogoutURL(a)},100);b=JSON.stringify({logoutURL:a,key:c._remoteKey}),c._remoteWindow.postMessage(b,c._remoteDomain)}},setLogoutURL:function(a){a&&""!==a&&this._registerUnloadHandler(),this.logoutURL=a},_registerUnloadHandler:function(){this._unloadHandler||(window.addEventListener?window.addEventListener("unload",this._logoutOnUnload.bind(this),!1):window.attachEvent("onunload",this._logoutOnUnload.bind(this)),this._unloadHandler=!0)},_initFailure:function(){for(;this._sendQueue.length;){var a=this._sendQueue.shift();this._xframeInitializationError(a.callback)}this._fatalError=!0},_logoutOnUnload:function(){var b,c=this.logoutURL;if(c){if(b=this._createXHR(),!b)return;b.open("get",c,a.UA.gecko?!0:!1),b.setRequestHeader("X-Yahoo-Msgr-User-Agent","YahooMessenger/1.0 (WC Messenger; 1.0.0.0)");try{b.send(null)}catch(d){}setTimeout(function(){b.abort()},3e3)}},_createXHR:function(){var a;if("undefined"!=typeof XMLHttpRequest)a=new XMLHttpRequest;else{if(!window.ActiveXObject)throw new Error("This browser does not support XMLHttpRequest.");a=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(a){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}throw new Error("This browser does not support XMLHttpRequest.")}()}return a},_xframeInternalError:function(a){a(JSON.stringify({error:{code:600,detail:"internal XFrame error"}}))},_xframeInitializationError:function(a){a({error:{code:701,detail:"XFrame initialization error"}})}},a.namespace("Messenger").Xframe=b},"1.0.0",{requires:[]});