YUI.add("common-ui-conv-listview-ext",function(e){var t=e.Node,n=e.one,r=e.Lang,i=e.Array,s=e.common.Utils,o=s.log,u=e.Object,a="#",f="list",l="requestSize",c="pageSize",h="page",p="dash",d="pageCount",v="loading",m=".",g="setrange",y="selected",b="remove",w="update",E="renderComplete",S="list-stat:scrolRenderComplete",x="KEY",T="SUBKEY",N="reverse",C="focused",k="tabIndex",L="height",A="prefetch",O="append",M=e.common.ui.TimeChunk,_,D;e.mix(e.common.ui.ConvListView.prototype,{_selectRange:function(t,n,r,i){var s=this,o=s._getIndexN,u,a,f,l,c;t._node&&(t=o(t)),r._node&&(r=o(r)),f=l=r;if(e.Lang.isNumber(r)){u=s._isSubindex(f),a=s._isSubindex(t);if(u!=a)return;if(u){if(s._getMainindex(f)!=s._getMainindex(t))return;t=s._getSubindex(t),f=s._getSubindex(f)}c=t<=f?-1:1;while(f!==t+c)s._selectByIndex(l,n,0,1,0,1),u?l[1]+=c:l+=c,f+=c}i||s.set("selectionCount",s.selCount())},_updateItem:function(r,i,s){var o=this,u="list-view-item-date-label",f="this-week",l="data-tc-label",c=i?o.stop()-1:r,h=o._model.valueAt(c),p=n(a+o._id(r)),d=p?o._getItemContainer(p):null,v=o.get("activeItem"),g,y,b,w,E,S,x,T,N,L,A,O,M,_,D;if(h&&p){S=v?o._getIndexN(v):-1,w=o._lastSel?o._getIndexN(o._lastSel):-1,E=o._lastSS?o._getIndexN(o._lastSS):-1,g=o.get(C)&&v,y=r==o._getMainindex(w),b=r==o._getMainindex(E),o.fire("beforeItemUpdate"),x=o._selectToRender(),NeoConfig.timeChunk&&o.listObj.timeChunk&&(O=p&&p.get("parentNode"),M=O&&O.previous(),_=NeoConfig.rearrangeMb&&M&&M.previous(),_&&_.hasClass(u)?(h.addDateLabel="",_.hasClass(f)&&(h.thisWeek=f,h.label=_.getAttribute(l))):M&&M.hasClass(u)?(h.addDateLabel="",M.hasClass(f)&&(h.thisWeek=f,h.label=M.getAttribute(l))):NeoConfig.timeChunkV2&&(h.addDateLabel="")),h.msgs&&h.msgs[0]&&(h.snippet=h.msgs[0].snippet),A=t.create(o._renderItem(h,c,x[c],o._id(c),s));if(i){if(g||y)T=p.next(m+o.ITEM_CLASS_NAME)||A;d.remove(),A&&o._srcNode.append(A)}else d&&d.replace(A);o.fire("itemUpdate",{itemIndex:c,itemNode:A}),e.fire("listview:itemUpdate",A,h),g&&v!=null&&o._getMainindex(S)==r&&(T=n(a+o._id(S)),T&&o._focusItem(T)),y&&(N=n(a+o._id(w)),N&&(o._lastSel=N)),b&&(L=n(a+o._id(E)),L&&(o._lastSS=L)),r==o.start()&&!v&&(D=A?A.one(".list-view-item"):null,D&&(D.set(k,0),o._focusItem(D,1)))}},_handleFailure:function(e){var t=this;e.start!==0&&e.reason!=="prefetch"&&t.set("page",t.get("page")-1,{noupdate:1}),t.set("freeze",0)},_listchange:function(e){var t=this,n,r,i=t._sel,a,f={},l,p,v,m,y,E=t.checkmode,S=e.subtype||"DEFAULT";o({m:"list model changed",reason:e.subtype});try{switch(e.subtype){case g:t._ss&&u.size(t._ss)&&(t._sel=t._model.indexesOf(t._ss)),t._sync(),t._lastSS=0,u.some(t._sel,function(e,n){return t._lastSel=t.getItemEl(n),1}),t._ss=0;break;case O:t._appendConversations(t.start(),t.stop());break;case A:break;case w:t._updateItem(e.index,!1,e.expand);break;case N:m=u.keys(i),p=m.length,a=t._model.get("length"),p===1?(v=m[0],y=v==a-v?v:a-v-1,t.set(h,Math.floor(y*1/t.get(c))),f[y]=i[m[0]]):t.set(h,0),t._clearSelect(1),t._sel=f,n=1,t.checkmode=E;break;case b:t._clearSelect(1),e.list&&e.list.length&&(r=t.getItemEl(e.list[0]))&&(t._set("activeItem",r),t._select(r,1)),t.get("isActive")||t._set("activeItem",null),l=t.get(d),t.get(h)>=l&&t.set(h,l-1),n=1,t.setAttrs({focused:!0});break;default:n=1}n&&t._sync(!1,S)}catch(x){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-common-ui-listview-conv-listview-ext:1",x,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-common-ui-listview-conv-listview-ext:1"),s.error.report("ConvView-ListExt listchange error for subtype: "+e.subtype,x,1,1,1)}},_appendConversations:function(e,t){var n=this,r=n._model.get(f),i=0,o=[],u=n._sel,a=n._srcNode,l=[],h=n.listObj?n.listObj.sortedColumn.sortOrder:"",p,d;if(_!==e||D!==t)n.setUpScrollSuccessRateStats(),_=e,D=t;if(n._r){n.fire("beforeRender"),n.fire("appendConversations"),n.set("showFocus",!1);for(d=e;d<t;d++){p=r[d];if(!p){i=1;break}l.push(r[d]),NeoConfig.timeChunk&&n.listObj.timeChunk&&(p.addDateLabel=M.addDateLabel(d,p,d>0?r[d-1]:"",h)),o.push(n._renderItem(p,d,u[d],n._id(d),!1))}i?(n._insertLoadingIndicator(),n._model.request(e,n.get(c),O)):a.all("."+n.PAGE_CLASS_NAME).size()*n.get(c)<e+1&&(n._removeLoadingIndicator(),a.appendChild('<div role = "presentation" class = "'+n.PAGE_CLASS_NAME+'">'+o.join("")+"</div>"),s.features.enabled("timeChunkV2")&&NeoConfig.timeChunk&&h==="down"&&M.addThisWeekLabel(),n.set("freeze",0),n.fire(E,{silent:!0}),n.fire(S),n._prefetch())}},_insertLoadingIndicator:function(){var e=this,t=e._srcNode,n="listloading";t.one("#"+n)||t.appendChild("<div id="+n+' class="s-loader"></div>')},_removeLoadingIndicator:function(){var e=this,t=e._srcNode.one("#listloading");t&&t.remove().destroy(!0)},_renderVisiblePages:function(){var e=this,t=e._srcNode.get("scrollTop"),n=e.getCurrentPage(t),r,i=n-1<0?n:n-1;for(r=i;r<=n+1;r++)e.renderPage(r);o({m:"Rendered Mail list pages",currPage:n,range:i+"-"+n-1})},_sync:function(t,n){function u(){var r=this,i,u,a=r._model.get(f),h=0,p=r.stop(),d=t,v=r._srcNode,g=r._statusNode,b,w=r._maxLength,S=r._sel,x=r.get("activeItem"),T=[],N,k=[],A=0,O,_,D=r.get(c),P,H,B,j,F,I=v.one("."+r.PAGE_CLASS_NAME),q=r.listObj?r.listObj.sortedColumn.sortOrder:"",R=r.get("page");o({m:"Entering sync",syncReason:n}),I&&(_=parseInt(I.getComputedStyle("height"),10)),H=r.getCurrentPage();if(r._r){r.fire("beforeRender"),r.set("showFocus",!1),N=r._selectToRender();for(i=h;i<p;i++){u=a[i];if(!u){d=1,A=i;break}k.push(a[i]),i%D===0&&(P=i/D,i!==0&&T.push("</div>"),!_||P>=H-1&&P<=H+1||P===R?T.push('<div role = "presentation" class = "'+r.PAGE_CLASS_NAME+'">'):T.push('<div role = "presentation" class = "'+r.PAGE_CLASS_NAME+'" style="height:'+_+'px">'));if(P>=H-1&&P<=H+1||P===R)i%D===0,NeoConfig.timeChunk&&r.listObj.timeChunk&&(u.addDateLabel=M.addDateLabel(i,u,i>0?a[i-1]:"",q)),T.push(r._renderItem(u,i,S[i],r._id(i),!1))}T.length&&T.push("</div>");if(d)p-A<200?(O=t?r.get(c)*2:r.get(c),B=Math.max(p-A,O)||r.get(l),o({m:"Sync din't find all the mails, request for more"
,from:A,size:B}),r._model.request(A,B)):r.refresh(1);else{g&&g.addClass("hidden"),e.common.Utils.features.enabled("predictiveSearch")?(j=e.Node.create(T.join("")||"<div></div>"),r.smwNode&&j&&r.listObj&&r.listObj.fid==="Inbox"&&j.insert(r.smwNode,0),v.insert(j,"replace")):v.setHTML(T.join("")),s.features.enabled("timeChunkV2")&&NeoConfig.timeChunk&&q==="down"&&(e.one(".list-view-items").removeClass("etw").setAttribute("data-tc-label",""),M.addThisWeekLabel()),v.setStyle(L,"auto");if(k.length){var U=e.one("body"),z=e.one("#main"),W=U&&U.hasClass("notoolbar")||z&&z.hasClass("withouttoolbar");W||(e.fire("mbEvent:rotate"),e.fire("rotateD2S"))}r.set("freeze",0)}r._maxLength=Math.max(w,v.get("offsetHeight")),t?r.set("activeItem",null):(b=r._parentNode,x=b.one(m+r.ITEM_CLASS_NAME+m+y),x||(n==="remove"?(k=b.all(m+r.ITEM_CLASS_NAME),x=k.item(k.size()-1)):x=b.one(m+r.ITEM_CLASS_NAME)),x&&(r.set("activeItem",x),r.get(C)&&r._focusItem(x),r._lastSel=x));if(!d){if(this.selCount()){if(r._lastSel)i=r._getIndexN(r._lastSel);else for(i in S)break;r._lastSS=r._lastSel=r.getItemEl(i)}r._prefetch(),e.fire("listview:sync",n),r.fire(E)}s.features.enabled("timeChunk")&&r.updateAnchoredLabel(!0,!1)}}o({m:"_sync called"});var i=this;i.tmSync&&i.tmSync.cancel(),i._tmSync=r.later(0,i,u)},_resetScrollTop:function(){var e=this._parentNode.one(m+this.LIST_CLASS_NAME);e.set("scrollTop",0)},_setStatus:function(t){var n=this,r,i=!1,s="";r=n._statusNode,t=t||"",i=t.hideLoader||!1,s=t.tmpl||t,!r&&n._parentNode&&(r=e.Node.create('<div role="'+n.STATUS_ROLE+'" tabindex="-1" class="status '+n.STATUS_CLASS_NAME+'"></div>'),r.addClass("hidden"),n._statusNode=r,n._parentNode.one("#lv-statuses-container").prepend(r),n._maxLength=Math.max(500,n._srcNode.get("offsetHeight"))),r&&(i?r.removeClass(v):r.addClass(v),s==="loading-icon"&&(s='<div class="s-loader"></div>'),n._status=s||"",s&&n.get("focused")&&r.focus(),r.setContent(n._status),r.removeClass("hidden"),n._srcNode.setContent(""),n._srcNode.setStyle(L,n._maxLength+"px"))},_prefetch:function(){var e=this,t=e._model.get(f),n=e.stop(),r=Math.min(t.length,n+e.get(c))-1;n<t.length&&!t[r]&&(o({m:"prefetching conversations",start:n,reqSize:e.get(c)*2}),e._model.request(n,e.get(c)*2,A))},_setSelection:function(e){function l(){s=t._model.get(f),i.each(e,function(e){a[e]=s[e]||1,n=e}),t._sel=a}var t=this,n,s=t._model.get(f),a={};t._clearSelect(),e=e?r.isObject(e)?u.keys(e):r.isArray(e)?e:[e]:[],l(),n&&(s[n]||t.once(E,l,t),t.set("page",Math.floor(n/t.get(c)),{noupdate:1})),o({m:"sync for _setSelection"}),t._sync()},_blur:function(){return},_moveToItem:function(e,t){var n=this,r=!0,i={188:1,190:1},s;if(e){n._focusItem(e);if(!t.metaKey&&!t.ctrlKey||t.ctrlKey&&!t.keycodeOverride&&i[t.keyCode]){t.shiftKey&&n._lastSel?n._select(n._lastSel,0,e,1,0,!0):n._clearSelect(),n._lastSel=e,n._select(e,1,n._lastSS,t.shiftKey);if(n.selCount()==1||!t.shiftKey)n._lastSS=e;r=!1}t.subselect&&(s=this._getSubindex(n._getIndexN(e)))>=0&&(n._subselIndex=s,n.fire("subselect"),n._subselIndex=-1),n.set("showFocus",r)}t.halt&&t.halt()},_expandItem:function(e,t,n){var r,i,s=this,o=s._model;o.expanding||(o.expanding=!0,(r=s._getSubitemContainer(n))?(s._showSubitems(r,e),o.expanding=!1):o.getSubitem(e,0)?(o.update(t,e,!0),n=s.getItemEl(t),i=s._getItemContainer(n),i.removeClass("expanded"),o.expanding=!1,s._expandItem(e,t,n)):o.requestSub(e,t),s.set("activeItem",n),s.set("showFocus",null),s.fire("expand"))},_getNeighborItem:function(e,t){var n=this,r,i,s,o=n._getIndexN(e),u=m+n.ITEM_DETAIL_CLASS_NAME;if(n._isSubindex(o))i=e[t?"next":"previous"](u),i||(i=n._getMasterItem(e),t&&(i=n._getNeighborMasterItem(i,t)));else{if(t&&e.ancestor(".list-view-item-container").hasClass("expanded")&&(r=n._getSubitemContainer(e)))if(i=n._getEndDetailItem(r,!0,!1))return i;i=n._getNeighborMasterItem(e,t);if(i&&!t&&i.ancestor(".list-view-item-container").hasClass("expanded")&&(r=n._getSubitemContainer(i)))if(s=n._getEndDetailItem(r,!1,!1))return s}return i},_resetSelection:function(e){var t=this,n,r,i,s,o=null,a=u.keys(t._sel);if(a)for(n=0;n<a.length;n++){r=t._toIndexN(a[n]);if(t._getMainindex(r)==e){i=t._getSubindex(r);if(i==-1){o=r;break}if(o==null||t._getSubindex(r)<t._getSubindex(o))o=r}}if(o!=null){t._clearSelect();if(s=t.getItemEl(o))t._set("activeItem",s),t._select(s,1);t.get("isActive")||t._set("activeItem",null)}},_disableMouseHover:function(){var t=this,n=e.one("#msg-list");if(!n)return;t.keyboardActiveEvent||(n.addClass("keyboard-active"),t.keyboardActiveEvent=n.on("mousemove",t._enableMouseHover,t))},_enableMouseHover:function(t){var n=this,r=e.one("#msg-list");n.clientX&&n.clientY?t.clientX!==n.clientX&&t.clientY!==n.clientY&&(r&&r.removeClass("keyboard-active"),n.keyboardActiveEvent.detach(),n.keyboardActiveEvent=null,n.clientX=null,n.clientY=null):(n.clientX=t.clientX,n.clientY=t.clientY)},_keydown:function(e){var t=this,r=t.get("activeItem"),i,s,o=m+t.ITEM_CLASS_NAME,u,f=t._getListItem(e,1),l,c,h,p,d,v,g,b=f?f.hasClass(y):0,w=0,E;t._disableMouseHover(),E=r?t._getIndexN(t.get("activeItem")):t._lastSel?t._getIndexN(t._lastSel):w,r||(r=t.getItemEl(E));if(!r||!t._srcNode.contains(r)){var S=Math.floor(E/t.get("pageSize"));t.renderPage(S,t._srcNode.all("."+t.PAGE_CLASS_NAME).item(S)),r=t.getItemEl(E)}t._set("activeItem",r);switch(e.keyCode){case 37:case 39:if(t.selCount()==1&&!t.get("previewPaneEnabled")){p=t._getIndexN(r),d=t.getItemEl(p),v=t._getItemContainer(d);if(v.hasClass("expanded")&&e.keyCode===37||!v.hasClass("expanded")&&e.keyCode===39){c=t._isSubindex(p),h=t._model.valueAt(p),l=t._model.isCollapsible(h),c&&(p=t._getMainindex(p));if(l||c)d=n(a+t._id(p)),t._expandItem(h,p,d),e.halt()}}break;case 38:case 40:case 188:case 190:e.altKey?(i=t.getItemEl(e.keyCode===38||e.keyCode===188?t.start():t.stop()-1),i&&(e.keyCode===40||e.keyCode===190)&&(s=t._getEndDetailItem(i,!1,!1))&&(i=s)):r&&(i=t.selCount()?t._getNeighborItem(r,e.keyCode===40||e.keyCode===190):r,i&&t._isSubindex(t._getIndexN(i))&&(g=e.ctrlKey,e.shiftKey=!1,e.ctrlKey=
e.metaKey=!0,e.subselect=!g,!g&&t.selCount()==1&&t.get("selection")[0]!=t._getMainindex(t._getIndexN(i))&&(t._clearSelect(),t._select(t._getMasterItem(i),1))),!e.shiftKey&&!e.metaKey&&!e.ctrlKey&&t._lastSel&&t._lastSel.get("id")!==r.get("id")&&!t._isSubindex(t._getIndexN(r))&&(i=r)),i&&(!e.shiftKey&&!e.metaKey&&!e.ctrlKey&&t.selCount()&&t._clearSelect(),i=t.getItemEl(t._getIndexN(i)),t._moveToItem(i,e)),e.halt();break;case 32:if(e.metaKey||e.ctrlKey||e.altKey)return;f||(f=t.getItemEl(E),b=f?f.hasClass(y):0);if(t._isSubindex(t._getIndexN(f)))return;if(!t._checkbox(e)){if(t._isFormControl(e))return;e.shiftKey?t._selectRange(t._lastSS,!t._sel[t._getIndexN(r)],f):(b&&!t.checkmode?u=1:u=!b,t._select(f,u,0,1),t._lastSel=t._lastSS=u?f:0),e.halt()}break;case 13:t.selCount()==1&&(p=t._getIndexN(r),h=t._model.valueAt(p),c=t._isSubindex(p),l=t._model.isCollapsible(h),c||!l||!t.get("expandOnClick")?(t.fire("command",{e:e,index:c?t._getSubindex(p):t._getMainindex(p),subindex:c?t._getSubindex(p):-1,mainindex:t._getMainindex(p),item:h}),t.get("previewPaneEnabled")||e.halt()):(d=n(a+t._id(p)),t._expandItem(h,p,d),e.halt()));break;case 36:t.scrollToTop(),e.halt();break;case 33:if(e.ctrlKey)break;t.pageUpOrDown(!0),e.halt();break;case 34:if(e.ctrlKey)break;t.pageUpOrDown(!1),e.halt()}},_isCheckboxBorder:function(e){var t=e.target,n,r=0,i=0,s,o;if(t.hasClass("list-view-item"))return NeoConfig.hoverPreview||(o=t.one("div.info"),o&&(r=o.get("offsetWidth"))),s=t.one("input"),s&&(i=s.get("offsetWidth")),n=t.getX()||0,e.clientX>n&&e.clientX<n+i+r},getPageIndex:function(e){var t=this,n=t.get("page"),r=t.get("pageSize"),i=t._getListItem(e,1),s=t._getIndexN(i),o=s-n*r;return o},setUpScrollSuccessRateStats:function(){var t=this;t.scrolRenderCompleteHandler&&t.scrolRenderCompleteHandler.detach(),e.fire("stat:feature_invoke",{message:"UI_LIST_CONV_SCROLL_START_SUCCESS",feature_group:"LIST"}),t.scrolRenderCompleteHandler=t.once(S,function(){e.fire("stat:feature_complete",{message:"UI_LIST_CONV_SCROLL_COMPLETE_SUCCESS",feature_group:"LIST"})})}},1),e.mix(e.common.ui.ConvListModel.prototype,{setRange:function(e,t,n){var r=this,i=t.length,s=t||[],o=r.get(f),u=o.length;n=n||g,r._refresh&&(o=[],o.length=u,r._refresh=0);while(i--)o[e+i]=s[i];r.set(f,o,{subtype:n,start:e})},update:function(e,t,n){var r=this.get(f);try{r[e]=t,this.set(f,r,{subtype:w,index:e,expand:n})}catch(i){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-common-ui-listview-conv-listview-ext:2",i,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-common-ui-listview-conv-listview-ext:2"),s.error.report("ConvView-ListExt update error",i,1,1,1)}},remove:function(t){var n=this,s=r.isArray(t)?i(t).sort(i.numericSort):u.keys(t),o=s.length,a=n.get(f);s=i(s).sort(i.numericSort),e.fire(n.NAME+":remove",a,s);while(o--)a.splice(s[o],1);n.set(f,a,{subtype:b,list:s})},reverse:function(){var e=this,t=e.get(f);t.reverse(),e.set(f,t,{subtype:N})},indexesOf:function(e,t,n){var s,o,u=this,a,l,c,h,d=u.get(t?T:x),v=u.get(f),m={},g={},y=v.length;e=r.isArray(e)?e:[e],i.each(e,function(e){m[e[d]]=e});for(s=0;s<y;s++){a=v[s];if(t){c=u.getSubitemCount(a);for(o=0;o<c;o++)l=u.getSubitem(a,o),l&&m[l[d]]&&(h=s+p+o,g[s+p+o]=l)}else if(a=v[s]&&m[a[d]])g[s]=a}return n&&n(g),g}},1)},"1.0.0",{requires:["common-ui-conv-listview","common-ui-notification","mail-common-utils-features","common-utils"]});
