YUI.add("xobni-contacts-search-api",function(e){function s(t){try{return e.JSON.parse(t)}catch(n){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-comms-shared-src-xobniContacts-xobni-contacts-search-api:1",n,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-comms-shared-src-xobniContacts-xobni-contacts-search-api:1"),n}}function o(){return e.common.net.Session.genReqID?e.common.net.Session.genReqID():"NO_YMREQID_LOADED"}function u(){return e.QueryString.stringify({ymreqid:o(),wssid:NeoConfig.wssid})}var t=e.xobniContacts.Utils,n=t.getXobniBaseURL(),r=e.common.Utils.ymmastats,i;e.namespace("xobniContacts").searchAPI={fetch:function(t,u,a){var f=t.timeout||2e3,l="limit"in t?t.limit:5,c,h,p,d;return c=n.url+"/v4/contacts/s?",h={q:t.query,l:t.limit||l,ymreqid:o()},p=e.QueryString.stringify(h),i=(new Date).getTime(),d={on:{success:function(t,n){var o=n.responseText&&n.responseText.length&&s(n.responseText),a=o&&e.Lang.isArray(o.r)?o.r:[];r.stat("xobni_contacts_s_latency","","milliseconds","duration",(new Date).getTime()-i),u&&u(a)},failure:function(e,t){t.statusText!=="abort"&&(t.statusText==="timeout",a&&a())}},timeout:f},n.xdr&&(d.xdr=n.xdr),t.origin?r.stat("search_xobnicontact","type=>searchsuggestion"):r.stat("search_xobnicontact","type=>normal"),e.io(c+p,d)},lookup:function(t,u,a){var f=t.timeout||2e3,l,c,h,p;return l=n.url+"/v4/contacts/lookup?",i=(new Date).getTime(),c={ep:t.ep,ymreqid:o(),wssid:NeoConfig.wssid},h=e.QueryString.stringify(c),p={on:{success:function(e,t){var n=t.responseText&&t.responseText.length&&s(t.responseText);r.stat("xobni_lookup_latency","","milliseconds","duration",(new Date).getTime()-i),u&&u(n)},failure:function(e,t){var n=t.responseText&&t.responseText.length&&s(t.responseText);t.statusText!=="abort"&&a(n)}},timeout:f},n.xdr&&(p.xdr=n.xdr),e.io(l+h,p)},edit:function(t,o,a){var f,l;return f=n.url+"/v4/contacts/edit?"+u()+"&y-dc=hc-"+NeoConfig.buildNumber,i=(new Date).getTime(),l={method:"POST",data:e.JSON.stringify(t.data),headers:{"Content-Type":"text/plain"},on:{success:function(e,t){var n=t.responseText&&t.responseText.length&&s(t.responseText);r.stat("xobni_edit_latency","","milliseconds","duration",(new Date).getTime()-i),o&&o(n)},failure:function(e,t){a(s(t))}}},n.xdr&&(l.xdr=n.xdr),e.io(f,l)},removePhoto:function(t,o,a){var f,l;return f=n.url+"/v4/contacts/removePhoto?"+u()+"&y-dc=hc-"+NeoConfig.buildNumber,i=(new Date).getTime(),l={method:"POST",data:e.JSON.stringify(t.data),headers:{"Content-Type":"text/plain"},on:{success:function(e,t){var n=t.responseText&&t.responseText.length&&s(t.responseText);r.stat("xobni_removePhoto_latency","","milliseconds","duration",(new Date).getTime()-i),o&&o(n)},failure:function(e,t){a(s(t))}}},n.xdr&&(l.xdr=n.xdr),e.io(f,l)},contactsByEp:function(t,o,a){var f,l;return f=n.url+"/v4/contacts/by/ep?"+u()+"&y-dc=hc-"+NeoConfig.buildNumber,i=(new Date).getTime(),l={method:"POST",data:e.JSON.stringify({ep:t.eps,is_composing:t.isCompose,enable_tmp:!0,contact_limit:1}),headers:{"Content-Type":"text/plain"},on:{success:function(e,t){var n=t.responseText&&t.responseText.length&&s(t.responseText);r.stat("xobni_contactsByEp_latency","","milliseconds","duration",(new Date).getTime()-i),o&&o(n)},failure:function(e,t){a(s(t))}}},n.xdr&&(l.xdr=n.xdr),e.io(f,l)},workflow:function(t,o,a){var f,l;return f=n.url+"/credentials/workflow?source="+t+"&"+u(),i=(new Date).getTime(),l={method:"POST",on:{success:function(e,t){var n=t.responseText&&t.responseText.length&&s(t.responseText);r.stat("xobni_workflow_latency","","milliseconds","duration",(new Date).getTime()-i),o&&o(n)},failure:function(e,t){a(s(t))}}},n.xdr&&(l.xdr=n.xdr),e.io(f,l)},formatted:function(t,o){var a,f;return a=n.url+"/v4/util/credentials/formatted?"+u(),i=(new Date).getTime(),f={on:{success:function(e,n){var o=n.responseText&&n.responseText.length&&s(n.responseText);r.stat("xobni_formatted_latency","","milliseconds","duration",(new Date).getTime()-i),t&&t(o)},failure:function(e,t){o&&o(s(t))}}},n.xdr&&(f.xdr=n.xdr),e.io(a,f)},photo:function(t,s,o){var u,a;return u=n.url+"/v4/contacts/"+t.id+"/photo?spsize=10X10&u="+t.updated+"&y-dc=hc-"+NeoConfig.buildNumber,i=(new Date).getTime(),a={method:"GET",on:{success:function(e,t){var n=t.getResponseHeader("x-image-source");r.stat("xobni_photo_latency","","milliseconds","duration",(new Date).getTime()-i),s&&s(n)},failure:function(e,t){o&&o()}}},n.xdr&&(a.xdr=n.xdr),e.io(u,a)}}},"1.0.0",{requires:["io-base","querystring-stringify-simple","json","ymma-stats","xobni-utilities","common-net-session"]});
YUI.add("_shared_module_xobni_contact_search_results_rollup",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_xobni_contact_search_results_rollup={base:"<div class='xobniPersonResult {{hasname}}' title=\"{{title}}\"> <div class='xobniPersonPic' style='background-image:url({{imageUrl}});' alt='thumbnail'></div> <div class='textHolder'> <span class='ac-value' role='option'> {{nameHighlightChunks}} <em> <div class=\"ac-value-email\"> {{emailHighlightChunks}} </div> <div class=\"ac-value-more\"> {{hasMoreThanOneEmail}} </div> </em> </span> </div></div>",hasname:"has-name",title:"str",highlight:"<b>{{str}}</b>",highlight_else:"{{str}}",nameHighlightChunks:"{{highlight}}{{highlight_else}} ",highlight1:"<b>{{str}}</b>",highlight_else1:"{{str}}",emailHighlightChunks:"({{highlight1}}{{highlight_else1}})</em> ",hasMoreThanOneEmail:"{{str}} "};},"1.0.0");YUI.add("xobni-contacts-search",function(e){function d(){return u}function v(t){var s=i._shared_module_xobni_contact_search_results_rollup,o=0,u=t.length,a,f,l=[],c;c={nameHighlightChunks:function(t){var i=[];return e.Array.forEach(t.nameHighlightChunks,function(e){e.str=n.escapeHtml(n.unescapeHtml(e.str)),e.highlight?i.push(r(s.highlight,e)):i.push(r(s.highlight_else,e))}),i.join("")},emailHighlightChunks:function(t){var i=[];return e.Array.forEach(t.emailHighlightChunks,function(e){e.str=n.escapeHtml(n.unescapeHtml(e.str)),e.highlight?i.push(r(s.highlight1,e)):i.push(r(s.highlight_else1,e))}),i.join("")},hasMoreThanOneEmail:function(t){if(t.original&&e.Array.test(t.original.a_e)){var n=t.original.a_e.length;if(n>0)return r(strings.str_xobni_search_suggestion_email_and_more,{num:n})}return!1},hasname:function(e){return e.name&&e.name.length?s.hasname:""},title:function(t){var n=[t.email];return t.original&&e.Array.test(t.original.a_e)&&e.Array.each(t.original.a_e,function(e){n.push(e)}),n.join("&#013;")}};for(o=0;o<u;++o)a=t[o],f=r(s.base,a,c,null,strings,i),l.push(f);return l}function m(){return a}function g(e){return l++===Number.MAX_VALUE&&(l=1),"xobni-contact-search_"+e+l}function y(t){e.fire("search:input",{query:{keyword:t,typeTag:"search_uh_suggestion_people"},displayQueryInSearchBar:!1,prefilterRefinements:!1,showDDWithSearchResults:!0,searchRequestId:g(t),addToRecentSearches:!1})}function b(t,n,r,i,s,o){var u=e.mail.ui.EntitySearch.findExactMatch(r.name),a=u?u.id:r.id,f=!0,l=arguments;if(e.Tictac&&!e.Tictac.contactdetails)f=!1;else if(!e.Tictac){e.once("tictacs-loaded:ws:postLoad",function(){b.apply(undefined,l)});return}f?u?e.fire("searchSuggestion:start",{type:"entity",id:u.id,typeTag:"search_uh_entity"}):e.fire("searchSuggestion:start",{type:"xContact",contactId:r.id,isFromQuery:!0,typeTag:"search_uh_suggestion_people"}):y(a),c.stat("searchsuggestions_contact","index=>"+(s+1)),o("")}function w(t,n){if(!t)return[];var r=[],i=0;return e.Array.each(n,function(e){var n=e.s,s=e.l;n<i?(r.push({highlight:!1,str:t.substring(i,n-1)}),i=n):n>i&&(r.push({highlight:!1,str:t.substring(i,n)}),i=n),n===i&&(r.push({highlight:!0,str:t.substr(n,s)}),i=n+s)}),i<=t.length-1&&r.push({highlight:!1,str:t.substr(i)}),r}function E(e,t){var n=e.e||"",r=e.f,i=r&&r.email||[];return t?w(n,i):n}function S(e,t){var n=e.n||"",r=e.f,i=r&&r.name||[];return t?w(n,i):n}function x(t,n){return e.Array.map(t,function(t){var r=n.contactIdStrToReplace,i=n.imageUrlTmpl.replace(r,t.i),s={},o;return e.common.net.Session.genReqID?s.ymreqid=e.common.net.Session.genReqID():s.ymreqid="NO_YMREQID_LOADED",s.ymreqid||(s.ymreqid="NO_YMREQID"),o=e.QueryString.stringify(s),o&&(i.indexOf("?")===-1?i+="?":i+="&",i+=o),{id:t.i,name:S(t,!1),email:E(t,!1),nameHighlightChunks:S(t,!0),emailHighlightChunks:E(t,!0),imageUrl:i,original:t}})}function T(e,t){var n,r={};h&&e.length>0&&c.stat("searchsuggestions_xobni_roundtrip","","milliseconds","duration",(new Date).getTime()-h),this._resetPendingIO(),this._prevResultsLen=e.length,t&&(n=x(e,{imageUrlTmpl:this._imageUrlTmpl,contactIdStrToReplace:f}),r[u]=n,t(r))}function N(e){var t={};this._resetPendingIO(),e&&(t[u]=[],e(t))}function C(e){e||(e={}),this._pendingIO=null,this._prevQuery=null,this._prevResultsLen=undefined,this._limit="limit"in e?e.limit:5,this._timeout="timeout"in e?e.timeout:5e3,this._imageUrlTmpl=p.url+"/v4/contacts/"+f+"/photo?fallback_url="+encodeURIComponent("https://s1.yimg.com/dh/ap/social/profile/profile_a48.png")}function k(e){return new C(e)}var t=e.xobniContacts.searchAPI,n=e.common.Utils,r=n.substitute,i=e.ui.Templates,s,o,u="xobniContactSearch",a="aclist-separator",f="{contactId}",l=0,c=e.common.Utils.ymmastats,h,p=e.xobniContacts.Utils.getXobniBaseURL();s={getType:d,render:v,activateIfFirstItem:!1,getSeparatorClass:m},o={getType:d,handleSelection:b},C.prototype={fetch:function(n,r){return this._resetPendingIO(),n&&n.length?this._prevResultsLen===0&&this._prevQuery&&this._prevQuery.length&&n.indexOf(this._prevQuery)===0?(this._prevQuery=n,T.call(this,[],r)):(this._prevQuery=n,this._prevResultsLen=undefined,h=(new Date).getTime(),this._pendingIO=t.fetch({query:n,limit:this._limit,timeout:this._timeout,origin:"searchSuggestions"},e.rbind(T,this,r),e.bind(N,this,r))):(this._prevQuery="",T.call(this,[],r)),{abort:e.bind(this._resetPendingIO,this)}},_resetPendingIO:function(){this._pendingIO&&this._pendingIO.isInProgress()&&this._pendingIO.abort(),this._pendingIO=null}},e.namespace("mail.ui").XobniContactsSearch={getDataFetcher:k,getRenderer:function(){return s},getSelectionHandler:function(){return o},doPeopleSearch:function(e,t,n,r){this.doPeopleSearchByType(e,"message",t,n,r)},doPeopleSearchByType:function(t,n,r,i,s){var o=this,u;e.xobniContacts.isXobnified(function(a){if(a)o.getDataFetcher().fetch(t,function(o){if(o&&o.xobniContactSearch&&o.xobniContactSearch.length)e.mail.ui.EntitySearch&&e.mail.ui.EntitySearch.findExactMatch&&(u=e.mail.ui.EntitySearch.findExactMatch(o.xobniContactSearch[0].name)),u?e.fire("searchSuggestion:start",{type:"entity",id:u.id}):e.fire("searchSuggestion:start",{type:"xContact",contactId:o.xobniContactSearch[0].id,viewType:n,isToQuery:i==="Sent"||i==="Draft",isFromQuery:i!=="Sent"&&i!=="Draft",typeTag:s});else{var a=e.contacts.utils.getContactsByEmail(t);a&&a[0]&&a[0].id?e.fire("searchSuggestion:start",{type:"abContact",contactId:a[0].id,emailAddress:t,viewType:n,isToQuery:i==="Sent"||i==="Draft",isFromQuery:i!=="Sent"&&i!=="Draft",typeTag:s}):r()}});else{var f=e.contacts.utils.getContactsByEmail(t);f&&f[0]&&f[0].id?e.fire("searchSuggestion:start",{type:"abContact",contactId:f[0].id,emailAddress:t,isToQuery:i==="Sent"||i==="Draft",isFromQuery:i!=="Sent"&&i!=="Draft"}):r()}})}}},"1.0.0",{requires:["querystring-stringify-simple","common-utils","xobni-contacts-search-api","ac-entity-search","contacts-api-utils","_shared_module_xobni_contact_search_results_rollup","ymma-stats","xobni-utilities","isXobnifiedCheck","common-net-session"]});
